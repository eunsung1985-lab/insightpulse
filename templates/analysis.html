{% extends "base.html" %}

{% block content %}
<div class="py-8 md:py-12" id="app">
    <!-- Analysis Mode Toggle -->
    <div class="flex justify-center mb-10">
        <div class="bg-slate-100 p-1 rounded-full flex">
            <button onclick="setMode('stock')" id="mode-stock"
                class="px-6 py-2 rounded-full font-bold text-sm transition-all shadow bg-white text-indigo-600">
                ğŸ“ˆ ì¢…ëª© ë¶„ì„ (Ticker)
            </button>
            <button onclick="setMode('link')" id="mode-link"
                class="px-6 py-2 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-slate-700">
                ğŸ”— ë‰´ìŠ¤ ë§í¬ ë¶„ì„ (URL)
            </button>
        </div>
    </div>

    <!-- Mode: Stock Analysis -->
    <div id="view-stock" class="block">
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="flex-grow mr-4">
                <input type="text" id="ticker-input" value="{{ ticker }}" placeholder="ì¢…ëª©ëª… ì…ë ¥"
                    onkeypress="if(event.key === 'Enter') loadAnalysis('neutral')"
                    class="text-3xl font-bold bg-transparent border-b-2 border-slate-200 focus:border-indigo-600 focus:outline-none w-full md:w-auto">
                <p class="text-slate-500 mt-1">AI ë‹¤ì¤‘ í˜ë¥´ì†Œë‚˜ ì‹¬ì¸µ ë¦¬í¬íŠ¸</p>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button onclick="loadAnalysis('neutral')"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">
                    ë¶„ì„ ì‹¤í–‰
                </button>
                <button onclick="savePDF()"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 flex items-center">
                    PDF ì €ì¥
                </button>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="switchTab('neutral')" id="tab-neutral"
                class="px-4 py-2 bg-indigo-600 text-white rounded-full font-bold whitespace-nowrap shadow-md transition-all">âš–ï¸
                í†µí•© ë¶„ì„</button>
            <button onclick="switchTab('optimist')" id="tab-optimist"
                class="px-4 py-2 bg-white text-slate-600 hover:bg-slate-50 rounded-full font-medium whitespace-nowrap border border-slate-200 transition-all">ğŸš€
                ë‚™ê´€ì  ì‹œê°</button>
            <button onclick="switchTab('critic')" id="tab-critic"
                class="px-4 py-2 bg-white text-slate-600 hover:bg-slate-50 rounded-full font-medium whitespace-nowrap border border-slate-200 transition-all">ğŸ›¡ï¸
                ë¹„íŒì  ì‹œê°</button>
        </div>

        <div class="glass-panel p-6 md:p-8 rounded-2xl shadow-sm min-h-[500px] relative">
            <div id="loading-stock"
                class="hidden absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-10 rounded-2xl">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            </div>
            <div id="analysis-content" class="prose prose-slate max-w-none whitespace-pre-line">
                ìƒë‹¨ì˜ 'ë¶„ì„ ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
        </div>
    </div>

    <!-- Mode: Link Analysis -->
    <div id="view-link" class="hidden">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800">ë‰´ìŠ¤ ë§í¬ ì—°ê´€ ì¢…ëª© ë¶„ì„</h2>
                <p class="text-slate-500">ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë¶„ì„í•˜ì—¬ íˆ¬ì ì•„ì´ë””ì–´ë¥¼ ë°œêµ´í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="flex gap-2 mb-8">
                <input type="text" id="url-input" placeholder="ë‰´ìŠ¤ ê¸°ì‚¬ URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
                    class="flex-grow px-4 py-3 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="analyzeLink()"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">
                    ë¶„ì„
                </button>
            </div>

            <div class="glass-panel p-6 md:p-8 rounded-2xl shadow-sm min-h-[400px] relative">
                <div id="loading-link"
                    class="hidden absolute inset-0 bg-white/50 backdrop-blur-sm flex flex-col items-center justify-center z-10 rounded-2xl">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-indigo-600 font-bold">ê¸°ì‚¬ ë‚´ìš©ì„ ì½ê³  ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
                <div id="link-result" class="prose prose-slate max-w-none whitespace-pre-line text-slate-700">
                    URLì„ ì…ë ¥í•˜ë©´ ì´ê³³ì— ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- MODE SWITCHING ---
    function setMode(mode) {
        document.getElementById('view-stock').classList.toggle('hidden', mode !== 'stock');
        document.getElementById('view-link').classList.toggle('hidden', mode !== 'link');

        // Toggle Button Styles
        const activeClass = "bg-white text-indigo-600 shadow".split(' ');
        const inactiveClass = "text-slate-500 hover:text-slate-700".split(' ');

        const stockBtn = document.getElementById('mode-stock');
        const linkBtn = document.getElementById('mode-link');

        if (mode === 'stock') {
            stockBtn.classList.add(...activeClass);
            stockBtn.classList.remove(...inactiveClass);
            linkBtn.classList.remove(...activeClass);
            linkBtn.classList.add(...inactiveClass);
            // Hide PDF button if in link mode? For now keeping simple.
        } else {
            linkBtn.classList.add(...activeClass);
            linkBtn.classList.remove(...inactiveClass);
            stockBtn.classList.remove(...activeClass);
            stockBtn.classList.add(...inactiveClass);
        }
    }

    // --- STOCK LOGIC ---
    let currentPersona = 'neutral';
    let cache = {};

    async function loadAnalysis(persona) {
        const ticker = document.getElementById('ticker-input').value;
        const contentDiv = document.getElementById('analysis-content');
        const loadingDiv = document.getElementById('loading-stock');

        if (!ticker) return alert("ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // Check cache
        const key = `${ticker}-${persona}`;
        if (cache[key]) {
            contentDiv.innerText = cache[key];
            return;
        }

        loadingDiv.classList.remove('hidden');

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker: ticker, persona: persona })
            });
            const data = await response.json();
            cache[key] = data.result;
            contentDiv.innerText = data.result;
        } catch (error) {
            contentDiv.innerText = "ë¶„ì„ ì‹¤íŒ¨: " + error;
        } finally {
            loadingDiv.classList.add('hidden');
        }
    }

    function switchTab(persona) {
        currentPersona = persona;
        loadAnalysis(persona);
        // ... (Update Tab Styles - reused from previous) ...
    }

    // --- LINK LOGIC ---
    async function analyzeLink() {
        const url = document.getElementById('url-input').value;
        const resultDiv = document.getElementById('link-result');
        const loadingDiv = document.getElementById('loading-link');

        if (!url) return alert("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        loadingDiv.classList.remove('hidden');

        try {
            const response = await fetch('/api/analyze_link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });
            const data = await response.json();
            if (data.success) {
                resultDiv.innerText = data.result;
            } else {
                resultDiv.innerText = "ë¶„ì„ ì˜¤ë¥˜: " + data.message;
            }
        } catch (error) {
            resultDiv.innerText = "í†µì‹  ì˜¤ë¥˜: " + error;
        } finally {
            loadingDiv.classList.add('hidden');
        }
    }

    // Initialize Check for URL params
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const link = urlParams.get('link');
        const ticker = urlParams.get('ticker');

        if (link) {
            setMode('link');
            document.getElementById('url-input').value = link;
            analyzeLink(); // Auto start
        } else if (ticker) {
            setMode('stock');
            // document.getElementById('ticker-input').value is already set by Jinja
            loadAnalysis('neutral');
        }
    });
    async function savePDF() {
        const ticker = document.getElementById('ticker-input').value;
        const content = document.getElementById('analysis-content').innerText;

        if (!ticker) return alert("ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (content.includes("ë¶„ì„ ì‹¤í–‰")) return alert("ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");

        if (!confirm(`${ticker} ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ PDFë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetch('/api/save_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker: ticker, content: content })
            });
            const data = await response.json();

            if (data.success) {
                alert(`ì„±ê³µ! êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në§í¬: ${data.link}`);
                window.open(data.link, '_blank');
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
            }
        } catch (error) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error);
        }
    }
</script>
{% endblock %}